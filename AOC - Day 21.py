#!/usr/bin/env python
# coding: utf-8

# In[2]:


INPUT = r"""
...................................................................................................................................
.##.....#........#........#...........#......#....##.....##....................#...#.......#.....................#......#.#........
...........................#.......#...#.#...#....#...........................#................##.......#....................#.#...
..............#..............##...#.....#.#...#..#.......#...................................#..#......#.......#....#...........##.
..........##...#..#......#...#.#..........................................#....................#.....................#.....#.......
..#............##.....................##.........#..............................#.............##.........##..................#.....
..............#.#..............................#...............................#....#...#..#.......................#...##..........
.....................#...#....#.......#.............#.#...........##...................#.#...........##......#.#......#.....#.#....
.....#.......#..........#...##.#.....#.......#.#.....#.......................#....#..#....................#.#.#....#.......#.......
..#............#.#..........#.....#.....#.......#..............................................#.................#.................
......#........##..........#........#............##......................................................#.........#...............
......#...#.....#....##.................#.......................#..#..............................#.......#..............#.....#...
.......#..#.......#..........#.............................#.##.........................................#...#.........#............
....................#.............#.#..............................#......#...........##...##..............#..#.....#..............
........#.........#...................#................##..#...#...#.......#.....................#...#........#.#.......#..........
.......................#..#.....##...........................#.#.....................#............#.#.............#.#...#..........
..#....#....#...............#........#.........................#......#...........................#.##..#.###..#....##.......#.....
...........#..##..............#...##............................#..#.....................#............#............................
...##.......#........#.#.....#.........#.#.........#..............##....................#.##.....#............#.................#..
...#......#....#............#............#...............#.#......#.............#.............#........#.#.##.........#....#....#..
.#...###.#....#..................#...#.................#......#........#...#.....#.......#...................#..........##.........
...#..........#........#.......#.................#......#...............#...................#..................#...#....#..........
...........#....#..................#...#.......#..........#....#......#......#...#...........#..........................#..#.......
....###...............#......#........#...............#...##...#...............##..............#....#..........#..#....#...........
.............##......#.#............#........#....................#.#.........#..............#................#.#..............#...
.###....#...............#.........#.#...............................#...#......###....................#.##.........#...............
......#..............#.........#.............#..#..#.......####.....................................#..#...........................
....#...#........#..........................#........#....#.#..#.............#...#...................#.............................
......#...#.................................#.....#...........#..................................................#....#.#..........
..........#.....#.................................##..#........#..................##.......................#.......................
..#..#.##.#.#..............#..#.................#..................#........#.........#..............#....................#.##.....
.........#.......#.....#.#...............#...#....#..#.............#...#...............................#...#.##...#.....#......#...
..#..#..........#.......................#............#...#............#............#..#...............#............................
.#..................##.#..............#..................#.....#..............#....#...#..##............................#...#...#..
.#.....#..#.........................#....#........#........#........#..##........#..........#.#.........##..#..........#........#..
...................#...##................#..........#.......#...............##....................................#...#............
................#...#.................#.....#..............#...............#......#...#....##...................#.....#.....#......
....................##............................#..##..##..##...........#.......#.#.#..#....#...................#................
..#........#.#..#....#..............#............................................##.................................#..............
..........#.......#...............................#.......#..#....#...#.......###.......#..........#.........#........#........#...
........................................#.............#.##........................#...............#..............#.................
...#...........................#.................#.......#..#.....#...#.........................#...#..........#.............#.....
..................................#...#..............#......#..##..#..#........#..#.#..........##....##..................#....#....
..#..........#....................#......#....#.........##....#..........#......##...#.....#........##...................#.........
..........#..............#.............................#...............................#.......................................#...
.............#..........#.......#...#.#..#..#..#...#.......#..#..........#..#......................................................
...#.....#.................##..##....#.#..#...................#......#......#...........#..#....#...................#.......###....
........#....................#....#...........#.............#...............#...........#...#.........................##..#.#......
.....................#...........#..#..#....#..............#..........#..#.........#..##..........#............................#...
...#......#.........................#.......#.......#...#.........#........................#.#.........#......#............#.......
....................#.#..#..................................................#......#............#.##........##..............#......
.......#...........#...#.#..#....#.#.......................##.................................#................................#...
.......#............#...#......#..#.#................#................................#...##....#..#...........#.............#.....
.........................#....................#.#..##..#..............#...#....#...##..............................................
.........................##..............#........#.#...........#........#.............#...........................#..........#....
.#....#..........................#......#..#...#...........#.......#..........................................#....................
....................#........#....#..#...........#.....................##.##.....#...#..................#..........#...............
.....................#....................#.#..................##.....#............#.......##..#...........#.......................
.....................#..#........#...#.#..................#....#.....................................#..........##....#............
...........................#.#....#...............#...............#........#........#...#..........#..........#....................
.................###......#.......#....................#.............#............#....................#.....#.......##............
.........##......#.....................#.....#..........#.....................#......#..........#.....................#............
..................#..#........##..###.....................#..........#......#...#......#.#......#......#.............#....#........
.........#....#.#.............#....#........#.....#..........#...........................#.......#....#...#........................
...........#.................................................#....................#.......#...........#...#.......#................
.................................................................S.................................................................
..................#...............#..........#..........####.............##......#.#...#.......###........#..................#.....
.......................#...#..##...................##..........................#...##..........##........#...##....................
............#................#.............................#................#......#..........##...................................
.............#....#.....##...............#....#..##...#.....#............................##..............#.........................
.............###.....#..........#.....................................#....#.#.........#................................#..........
..............#..........................................#........##...#.#.#...............#..........#............##............#.
............#....#............#.........#...........#.............#............................#..##..#............................
...#...................#.........#...#............#..#........................#.#.#..#..#.............#.....#......................
.................#........................#.........#..........#..#............#.#.....#...........#....#....#.................#...
.....#.................#....#........#.#......#............##.........#.#.........##...........#..#............#..#..............#.
.....................................................#..................................#..............#..#.......#..............#.
.......................................#...........#.........................................#...........#.....#..............#....
...#.#..#..........#...#.##.#..........................................#...............#.#.......#.......................#...#..#..
....##.##.#.........#...#......#.#.#..........................................#.........#......##...#......#................#......
.......................#...#......#....#...#...#.......#......................#...........................#.#......................
.......#..#.................#...#...#...........#........#.........#......#.#.#...##.............#....................#..#.........
........................................................#.............................#..........#...#.................#...........
............###......................#.................................#..................................##...............#.......
..........................................#.#........................#......#.#..#..................#..#......................#.#..
.........##........................#...#....#.....#.#......#...................#.............#.........#............#.#.#..#.......
......#......................##...........#....#.##.....#......#..#...#..#.........#..#...#....#.......................##....#.....
..............................#......#........#...#............#.........#.##..........................#.........#..........#.#....
...##...#....................#.....#................................##.....#.......................#...........#..#....#...........
.......#....#...#...................#.#...........#......#..........#......#...........#.............#....................#......#.
.................................#......#.#...............#.......#..........#.#..#.#.............#..........###....#..#...........
..............#..#....#..............................................#......#.........#...........................#................
.#..........#....#....#..........#..#.........................#...#.....#.....................##...#...............#.....#.........
.......#.......#.#.......................#...............#.........#.......................##.....................#......#...#.....
.....................................#....#.........#.....#...................##............#...............................#.#....
........#...#...#.....................................##...............#.......#...#.......#...............#..#.........#.....#....
....#............#........#............................#......#.....#.#..#..............................#...#..#...#...............
.....#..................#..............#............#.............#.#.#.#......#......#................#.....#.....................
.......#...........#.........................#...............##....#..##.......#........#.................#..............#...#.....
..#..#.......#.#......#......#...........#.#..................#...#..##..#...........#........................###..........#.......
........#......................#........#........##.#......................##..#...#............................#...........#......
...............#.....#........#.#...................#.......#..............#............#........................#.....#..#..#.....
........##...#....#....#.......................................#.........#..##......................##..#......#...................
..#..........#.....#....#.#..#.....................................#...#.#..#..#.#.#..#............#.............##................
..................#......#...................##........#.......##...#.............#............................##.........#........
......................#........#.#.#...........#.......#.#.....................................#.............#....##.......#....#..
.............#.....#...........#..#.............##...#..#.............................................#...........#.#...#.....#....
..........................#..#..................#.......#..#.........#......#..#..................#....#..........#.#...#..........
.....#.........##.....#.......#.......#.........#..#.##...#...................#..........................#......#.#................
....#.#.................#...........#.......................................#.....#.........#.............#..................#.....
....#.....#.................#.#....#...#...............#.....#.............#.............#..................#.......#.....#....#...
.....#..........................#..#.........................#........#....#..#.................##...............................#.
.......#..................................................#...............................#......#.............#....#..............
..#...#......##......................#....................#.........#........................#.......#....#.......#...#....#.......
........#..........#....................#....#.............##...........##...........#..........................................#..
.###................#..........#......................#.......#.......#.............#..............................#......#....#...
...#......#...#.#........#.....#.........##.........................#.#....................#......................#.#...........##.
..........#.........................#....#.....##............#.....................#...............................................
..#...........##...............................#.#.................#..............#.............#..#................#..#...........
......#............#..#...........#.............#.........#....#..#.............#....#............#...........#.....#..............
...##..#..........#...#..................#.....#...............#.....#.................................###..............#..........
..............#.#.................#...........#................#....#...........#.........#.........#...#..............#...........
................#.#...#.......#.........#.#..#...............................#.#....................#......#.......#.....#.........
....................#...#....#...#............#....#............................#.#.#......##.#...##......#.#.#.....#..........#...
.........#..............#..#......#............#.................................#..........#......#.........#...........#..#..##..
...#.#....#.....##..................#.##..##....#.......#.......#.............................................................#....
.....#..#.......#...................#.........................................#...#.................#......................#....#..
............................................................................#......................................................
......................#.....#......#...#..........#........#..............................#.#..#..........#........##..............
..................##...#......#.#.#...#..##.........#......#.................##.....#...#.......#...#....#..#....#......##.........
...................................................................................................................................
"""


# In[3]:


from collections import deque
from functools import cache

MAX_TILES = 4

def parse_input():
    garden = [list(row) for row in INPUT.strip().splitlines()]
    rows = len(garden)
    cols = len(garden[0])
    start = (0, 0)
    for r in range(rows):
        for c in range(cols):
            if garden[r][c] == 'S':
                start = (r,c)

    dests = {}
    queue = deque([(0,0,start[0],start[1],0)])
    while queue:
        tile_r,tile_c,r,c,dist = queue.popleft()
        if r<0:
            tile_r-=1
            r += rows
        if r>=rows:
            tile_r += 1
            r -= rows
        if c<0:
            tile_c -= 1
            c += cols
        if c >= cols:
            tile_c += 1
            c -= cols
        if not (0<=r<rows and 0<=c<cols and garden[r][c]!='#'):
            continue
        if (tile_r,tile_c,r,c) in dests:
            continue
        if abs(tile_r) > MAX_TILES or abs(tile_c) > MAX_TILES:
            continue
        dests[(tile_r,tile_c,r,c)] = dist

        for dr,dc in  [[-1,0],[0,1],[1,0],[0,-1]]:
            queue.append((tile_r,tile_c,r+dr,c+dc,dist+1))
        
    return dests, rows, cols, start

@cache
def solve(dist,corner,rows,steps):
  amt = (steps-dist)//rows
  ret = 0
  for x in range(1,amt+1):
    if dist+rows*x<=steps and (dist+rows*x)%2==(steps%2):
        if corner:
            ret += x+1
        else:
            ret += 1

  return ret

def day21_puzzle1():
    dests, rows, cols, _ = parse_input()
    res = 0
    for r in range(rows):
        for c in range(cols):
            if (0,0,r,c) not in dests:
                continue
            dist = dests[(0,0,r,c)]
            # Reachable in <= 64 steps or an even number of steps (back and forth)
            if dist%2==64%2 and dist<=64:
                res += 1
    print(f"Part 1: {res}")

def day21_puzzle2():
    dests, rows, cols, start = parse_input()
    res = 0
    OPT = [-3,-2,-1,0,1,2,3]
    for r in range(rows):
        for c in range(cols):
            if (0,0,r,c) not in dests:
                continue
            for tr in OPT:
                for tc in OPT:
                    dist = dests[(tr,tc,r,c)]
                    if dist%2==26501365%2 and dist<=26501365:
                        res += 1
                    if tr in [min(OPT),max(OPT)] and tc in [min(OPT),max(OPT)]:
                        res += solve(dist,True,rows,26501365)
                    elif tr in [min(OPT),max(OPT)] or tc in [min(OPT),max(OPT)]:
                        res += solve(dist,False,rows,26501365)

    print(f"Part 2: {res}")

day21_puzzle1()
day21_puzzle2()


# In[8]:


from collections import deque


def solve(grid, n):
    width = len(grid[0])
    height = len(grid)

    q = deque()
    sx, sy = width // 2, height // 2

    q.append((sx, sy, 0))
    reachable = set()
    visited = set()

    while q:
        x, y, steps = q.popleft()
        if (x, y, steps) in visited:
            continue
        visited.add((x, y, steps))
        if steps == n:
            reachable.add((x, y))
        else:
            if x >= 0:
                if grid[y][x - 1] != "#":
                    q.append((x - 1, y, steps + 1))
            if x < width - 1:
                if grid[y][x + 1] != "#":
                    q.append((x + 1, y, steps + 1))
            if y >= 0:
                if grid[y - 1][x] != "#":
                    q.append((x, y - 1, steps + 1))
            if y < height - 1:
                if grid[y + 1][x] != "#":
                    q.append((x, y + 1, steps + 1))

    return len(reachable)

def day21_puzzle1():
    grid = INPUT.strip().splitlines()
    res = solve(grid, 64)
    print(f"Part 1: {res}")
    
def day21_puzzle2():
    lines = INPUT.strip().splitlines()
    width = len(lines[0])

    grid = []
    for i in range(5):
        for line in lines:
            grid.append(5 * line.replace("S", "."))

    # Extrapolate polynomials
    n = 26501365//width
    mod = 26501365%width
    a0 = solve(grid, mod)
    a1 = solve(grid, width+mod)
    a2 = solve(grid, 2 * width + mod) # repeating pattern due to even/odd

    # Lagrange interpolation
    a = a0/2 - a1 +a2/2
    b = -3 * a0/2 + 2*a1 - a2/2
    c = a0
    res = int(a*n*n + b*n +c)
    
    print(f"Part 2: {res}")

day21_puzzle1()
day21_puzzle2()


# In[ ]:




